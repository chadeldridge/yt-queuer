const resLogSize=4,menuItemIconClass=newClassList(["material-symbols-outlined","text-lg","mr-1","text-neutral-100"]),menuItemClass=newClassList("block flex flex-row w-full whitespace-nowrap items-center px-4 py-2 leading-5 cursor-pointer bg-neutral-800 text-neutral-100 hover:bg-neutral-700 focus:outline-none focus:bg-neutral-500 focus:text-neutral-900".split(" "));let resLog=[];
function printResLog(){let a="<div class='flex flex-col pl-3 pt-2 text-sm'>";for(let b=0;b<resLog.length;b++){let c="";resLog.length-1==b&&(c=' class="text-neutral-100"');a+=`<span${c}>${resLog[b]}</span>`}resultsDiv.innerHTML=a+"</div>"}function addResLog(a){resLog.push(a);resLog.length>resLogSize&&resLog.shift();printResLog()}function log(a){console.log(a);addResLog(a)}
function handleFailure(a,b){b.response?(console.log(b.response),a=`${a}: (${b.response.status})`,b.response.data&&b.response.data.message&&(a+=` ${b.response.data.message}`),log(a)):b.request?log(`${a}: No response received`):log(`${a}: ${b.message}`)}function setCookie(a,b){var c=new Date;c.setTime(c.getTime()+31536E6);c="expires="+c.toUTCString();b=JSON.stringify(b);document.cookie=`${a}=${b}; ${c}; path=/; SameSite=None; secure`}
function getCookie(a){(a=document.cookie.match(new RegExp(a+"=([^;]+)")))&&(a=JSON.parse(a[1]));return a}function deleteCookie(a){document.cookie=`${a}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=None; secure`}function newElement(a,b,c){let d=document.createElement(a);b&&(Array.isArray(b)?b.forEach(e=>{d.classList.add(e)}):"string"===typeof b?d.classList.add(b):d.classList=b);c&&(d=addElements(d,c));return d}
function addElements(a,b){Array.isArray(b)?b.forEach(c=>{a.appendChild(c)}):"string"===typeof b?a.innerHTML+=b:a.appendChild(b);return a}function newClassList(a){const b=document.createElement("div");a&&0<a.length&&a.forEach(c=>{b.classList.add(c)});return b.classList}function toggleHidden(a){a.classList.toggle("hidden")}function showElement(a){a.classList.contains("hidden")&&a.classList.remove("hidden")}function hideElement(a){a.classList.contains("hidden")||a.classList.add("hidden")};let pbc="",currentVideo="",nextVideo="",waitingForNextVideo=!1;const registerDiv=document.getElementById("register"),registerForm=document.getElementById("registerForm"),resultsDiv=document.getElementById("results"),COOKIE_NAME="ytqueuer-playback_client";let player,firstScriptTag,tag;const playerDiv=document.getElementById("player");function startup(){pbc=getCookie(COOKIE_NAME);null===pbc||""===pbc?(showElement(registerDiv),hideElement(playerDiv)):showPlayer()}
function showPlayer(){playerDiv.outerHTML='<iframe id="player" type="text/html"\n\tsrc="https://www.youtube.com/embed/e4dmA-yJ4c0?enablejsapi=1"\n\tframeborder="0"\n\tstyle="width: 100%; height: 100%; position: absolute; top: 0; right: 0; bottom: 0; left: 0;">\n</iframe>';hideElement(registerDiv);showElement(playerDiv);tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,
firstScriptTag)}function onYouTubeIframeAPIReady(){player=new YT.Player("player",{playerVars:{enablejsapi:1,playsinline:0,controls:0,disablekb:0,rel:0,showinfo:0,autoplay:1,loop:0,fs:0,cc_load_policy:0,iv_load_policy:3,autohide:1,origin:"http://localhost:8080"},events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}})}const getPlaybackClientList=async()=>{try{await axios.get("/pbcs")}catch(a){handleFailure("Failed to get playback client list",a)}};
function onPlayerReady(a){playNextVideo()}function onPlayerStateChange(a){a.data==YT.PlayerState.ENDED&&playNextVideo()}function retryNextVideo(){waitingForNextVideo=!1;getNextVideo()}
const getNextVideo=async()=>{try{if(!waitingForNextVideo){waitingForNextVideo=!1;var a=await axios.get(`/playlists/${pbc.id}/next`);200!==a.status?(currentVideo=a.status,waitingForNextVideo=!0,window.setTimeout(retryNextVideo,2E3)):(currentVideo=a.data,player.loadVideoById(currentVideo.video_id,currentVideo.start_seconds))}}catch(b){currentVideo=b.status,handleFailure("Failed to get next video",b),waitingForNextVideo=!0,window.setTimeout(retryNextVideo,1E4)}},peekNextVideo=async()=>{try{const a=await axios.get(`/playlists/${pbc.id}/peek`);
nextVideo=204===a.status?204:a.data}catch(a){nextVideo=a.status,handleFailure("Failed to peek next video",a)}},removeVideo=async a=>{try{const b=await axios.delete(`/playlists/${pbc.id}/${a}`);204!==b.status&&log("failed to remove video:"+b.data.message)}catch(b){handleFailure("Failed to remove video",b)}},playNextVideo=async()=>{try{null!==currentVideo&&""!==currentVideo&&204!==currentVideo&&await removeVideo(currentVideo.video_id),await getNextVideo(),404===currentVideo&&(deleteCookie(COOKIE_NAME),
startup())}catch(a){handleFailure("Failed to play next video",a)}};
registerForm.addEventListener("submit",async a=>{a.preventDefault();a=new FormData(registerForm);a=Object.fromEntries(a.entries());try{if(null===a.name||""===a.name)log("name cannot be empty");else{var b=await axios.post("/pbcs/register?name="+a.name);200!==b.status?log("failed to register playback client:"+b.data.message):(log("playback client registered"),setCookie(COOKIE_NAME,b.data),startup())}}catch(c){handleFailure("Failed to register playback client",c)}});startup();
